
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>KVM run and exit &#8212; ARM SoC Device Assignment Notes  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Oenhan KVM note" href="oenhen_part2_3.html" />
    <link rel="prev" title="QEMU thread and event model" href="qemu_thread_event.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="kvm-run-and-exit">
<h1>KVM run and exit<a class="headerlink" href="#kvm-run-and-exit" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="http://blog.csdn.net/dashulu/article/details/17090293">http://blog.csdn.net/dashulu/article/details/17090293</a></p></li>
</ul>
<p>Qemu run vcpu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kvm_cpu_exec</span><span class="p">()</span>

<span class="o">-</span> <span class="n">kvm_vcpu_ioctl</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">KVM_RUN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="o">-</span> <span class="n">switch</span> <span class="p">(</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span><span class="p">)</span> <span class="o">...</span>
</pre></div>
</div>
<p>KVM_RUN vcpu_ioctl:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[x86]

   kvm_vcpu_ioctl()
=&gt; kvm_arch_vcpu_ioctl_run() // x86 version
=&gt; vcpu_run()                // infinite loop for VM
=&gt; vcpu_enter_guest()

   - kvm_x86_op-&gt;run() = vmx_vcpu_run()

     - run guest OS. // inline asm, VMLAUNCH
     - vmx-&gt;exit_reason = vmcs_read32(VM_EXIT_REASON);

   - kvm_x86_op-&gt;handle_exit() = vmx_handle_exit()

     - kvm_vmx_exit_handlers[vmx-&gt;exit_reason]

[arm64]

   kvm_vcpu_ioctl()
=&gt; kvm_arch_vcpu_ioctl_run()

   [1] ret = kvm_call_hyp(__kvm_vcpu_run, vcpu);

       [ ] kvm_call_hyp == __kvm_call_hyp // kvm_call_hyp at ``arch/arm64/include/asm/kvm_host.h``
       [ ] __kvm_vcpu_run == __guest_run
       [2] __guest_run() // at ``arch/arm64/kvm/hyp/switch.c``

           [3] vcpu = kern_hyp_va(vcpu);
           [3] host_ctxt = kern_hyp_va(vcpu-&gt;arch.host_cpu_context);
           [3] again: exit_code = __guest_enter(vcpu, host_ctxt); // at ``arch/arm64/kvm/hyp/entry.S``

               [4] run guest OS by exception return instruction (ERET) // PC = ELR_hyp, CPSR = SPSR_hyp

           [3] if (exit_code == ARM_EXCEPTION_TRAP &amp;&amp; !__populate_fault_info(vcpu)) goto again

   [1] handle_exit() // arm64/kvm/handle_exit.c , arm/kvm/handle_exit.c

       [2] arm_exit_handlers[]
</pre></div>
</div>
<hr class="docutils" />
<ul class="simple">
<li><p>QEMU / KVM interface</p>
<ul>
<li><p>enter: kvm_vcpu_ioctl(KVM_RUN)</p></li>
<li><p>exit: ioctl syscall return, struct kvm_run (shared memory, mmap vcpu_fd)</p>
<ul>
<li><p>struct kvm_run: Documentation/virtual/kvm/api.txt ch5 The kvm_run structure</p></li>
<li><p>QEMU use <code class="docutils literal notranslate"><span class="pre">kvm_run-&gt;exit_reason</span></code> to do device emulation and … etc. (<code class="docutils literal notranslate"><span class="pre">kvm_cpu_exec</span></code>)</p></li>
<li><p>shared memory, mmap vcpu_fd: <code class="docutils literal notranslate"><span class="pre">env-&gt;kvm_run</span> <span class="pre">=</span> <span class="pre">mmap(NULL,</span> <span class="pre">mmap_size,</span> <span class="pre">PROT_READ</span> <span class="pre">|</span> <span class="pre">PROT_WRITE,</span> <span class="pre">MAP_SHARED,</span> <span class="pre">env-&gt;kvm_fd,</span> <span class="pre">0);</span> <span class="pre">at</span> <span class="pre">kvm_init_vcpu()</span></code></p></li>
</ul>
</li>
</ul>
</li>
<li><p>KVM / Guest interface</p>
<ul>
<li><p>[x86] enter: vmlaunch instruction</p></li>
<li><p>[x86] exit: vmexit, VMCS exit_reason field</p></li>
<li><p>[arm64] enter: ERET or ?? instruction</p></li>
<li><p>[arm64] exit: HSR register</p></li>
</ul>
</li>
</ul>
<hr class="docutils" />
<p>MMIO:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>-  arm_exit_handlers[ESR_ELx_EC_IABT_LOW, ESR_ELx_EC_DABT_LOW] = kvm_handle_guest_abort()
=&gt; kvm_handle_guest_abort() // at ``arch/arm/mmu.c``

   - io_mem_abort()         // at ``arch/arm/mmio.c``

     - kvm_io_bus_write() (or read)                // at ``virt/kvm/kvm_main.c``
     - kvm_handle_mmio_return()
     - run-&gt;exit_reason = KVM_EXIT_MMIO; return 0; // handled in userland, QEMU emulation

   - user_mem_abort()       // at ``arch/arm/mmu.c``
</pre></div>
</div>
<p>MMIO2</p>
<ul class="simple">
<li><p>kvm_io_bus_write()     // at <code class="docutils literal notranslate"><span class="pre">virt/kvm/kvm_main.c</span></code></p>
<ul>
<li><p>kvm_iodevice_write()</p></li>
</ul>
</li>
</ul>
<p>IO device and bus</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">kvm_io_device</span></code> at <code class="docutils literal notranslate"><span class="pre">include/kvm/iodev.h</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">kvm_io_device_op</span></code> has read, write, destructor 3 function pointers</p></li>
<li><p>kvm_iodevice_write() = dev-&gt;op-&gt;write() // kvm_iodevice_read/destructor also</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">kvm_io_bus</span></code> at <code class="docutils literal notranslate"><span class="pre">include/linux/kvm_host.h</span></code></p>
<ul>
<li><p>example:</p>
<ul>
<li><p>(<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">kvm_io_bus</span></code>) bus-&gt;range[idx].dev</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">kvm_io_bus</span></code> =&gt; <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">kvm_io_range</span></code> =&gt; <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">kvm_io_device</span></code></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">ARM SoC Device Assignment Notes</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../qemu_kvm.html">QEMU/KVM note</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../qemu_kvm.html#qemu-basic">QEMU Basic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qemu_kvm.html#memory">Memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qemu_kvm.html#ivshmem">ivshmem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qemu_kvm.html#qemu-net">QEMU Net</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qemu_kvm.html#qemu-misc">QEMU Misc</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../qemu_kvm.html#kvm">KVM</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../device_driver.html">Linux Device Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dma.html">DMA note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vfio.html">VFIO</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../platform.html">Platform Installations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../perf.html">Perf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc.html">Misc</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, susu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/notes/qemu_kvm/run_and_exit.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>